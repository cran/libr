<!DOCTYPE html>

<html>

<head>

<meta charset="utf-8" />
<meta name="generator" content="pandoc" />
<meta http-equiv="X-UA-Compatible" content="IE=EDGE" />

<meta name="viewport" content="width=device-width, initial-scale=1" />



<title>Data Step Operations</title>

<script>// Pandoc 2.9 adds attributes on both header and div. We remove the former (to
// be compatible with the behavior of Pandoc < 2.8).
document.addEventListener('DOMContentLoaded', function(e) {
  var hs = document.querySelectorAll("div.section[class*='level'] > :first-child");
  var i, h, a;
  for (i = 0; i < hs.length; i++) {
    h = hs[i];
    if (!/^h[1-6]$/i.test(h.tagName)) continue;  // it should be a header h1-h6
    a = h.attributes;
    while (a.length > 0) h.removeAttribute(a[0].name);
  }
});
</script>

<style type="text/css">
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
span.underline{text-decoration: underline;}
div.column{display: inline-block; vertical-align: top; width: 50%;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
</style>



<style type="text/css">
code {
white-space: pre;
}
.sourceCode {
overflow: visible;
}
</style>
<style type="text/css" data-origin="pandoc">
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
{ counter-reset: source-line 0; }
pre.numberSource code > span
{ position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
{ content: counter(source-line);
position: relative; left: -1em; text-align: right; vertical-align: baseline;
border: none; display: inline-block;
-webkit-touch-callout: none; -webkit-user-select: none;
-khtml-user-select: none; -moz-user-select: none;
-ms-user-select: none; user-select: none;
padding: 0 4px; width: 4em;
color: #aaaaaa;
}
pre.numberSource { margin-left: 3em; border-left: 1px solid #aaaaaa; padding-left: 4px; }
div.sourceCode
{ }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
code span.al { color: #ff0000; font-weight: bold; } 
code span.an { color: #60a0b0; font-weight: bold; font-style: italic; } 
code span.at { color: #7d9029; } 
code span.bn { color: #40a070; } 
code span.bu { color: #008000; } 
code span.cf { color: #007020; font-weight: bold; } 
code span.ch { color: #4070a0; } 
code span.cn { color: #880000; } 
code span.co { color: #60a0b0; font-style: italic; } 
code span.cv { color: #60a0b0; font-weight: bold; font-style: italic; } 
code span.do { color: #ba2121; font-style: italic; } 
code span.dt { color: #902000; } 
code span.dv { color: #40a070; } 
code span.er { color: #ff0000; font-weight: bold; } 
code span.ex { } 
code span.fl { color: #40a070; } 
code span.fu { color: #06287e; } 
code span.im { color: #008000; font-weight: bold; } 
code span.in { color: #60a0b0; font-weight: bold; font-style: italic; } 
code span.kw { color: #007020; font-weight: bold; } 
code span.op { color: #666666; } 
code span.ot { color: #007020; } 
code span.pp { color: #bc7a00; } 
code span.sc { color: #4070a0; } 
code span.ss { color: #bb6688; } 
code span.st { color: #4070a0; } 
code span.va { color: #19177c; } 
code span.vs { color: #4070a0; } 
code span.wa { color: #60a0b0; font-weight: bold; font-style: italic; } 
</style>
<script>
// apply pandoc div.sourceCode style to pre.sourceCode instead
(function() {
  var sheets = document.styleSheets;
  for (var i = 0; i < sheets.length; i++) {
    if (sheets[i].ownerNode.dataset["origin"] !== "pandoc") continue;
    try { var rules = sheets[i].cssRules; } catch (e) { continue; }
    var j = 0;
    while (j < rules.length) {
      var rule = rules[j];
      // check if there is a div.sourceCode rule
      if (rule.type !== rule.STYLE_RULE || rule.selectorText !== "div.sourceCode") {
        j++;
        continue;
      }
      var style = rule.style.cssText;
      // check if color or background-color is set
      if (rule.style.color === '' && rule.style.backgroundColor === '') {
        j++;
        continue;
      }
      // replace div.sourceCode by a pre.sourceCode rule
      sheets[i].deleteRule(j);
      sheets[i].insertRule('pre.sourceCode{' + style + '}', j);
    }
  }
})();
</script>




<style type="text/css">body {
background-color: #fff;
margin: 1em auto;
max-width: 700px;
overflow: visible;
padding-left: 2em;
padding-right: 2em;
font-family: "Open Sans", "Helvetica Neue", Helvetica, Arial, sans-serif;
font-size: 14px;
line-height: 1.35;
}
#TOC {
clear: both;
margin: 0 0 10px 10px;
padding: 4px;
width: 400px;
border: 1px solid #CCCCCC;
border-radius: 5px;
background-color: #f6f6f6;
font-size: 13px;
line-height: 1.3;
}
#TOC .toctitle {
font-weight: bold;
font-size: 15px;
margin-left: 5px;
}
#TOC ul {
padding-left: 40px;
margin-left: -1.5em;
margin-top: 5px;
margin-bottom: 5px;
}
#TOC ul ul {
margin-left: -2em;
}
#TOC li {
line-height: 16px;
}
table {
margin: 1em auto;
border-width: 1px;
border-color: #DDDDDD;
border-style: outset;
border-collapse: collapse;
}
table th {
border-width: 2px;
padding: 5px;
border-style: inset;
}
table td {
border-width: 1px;
border-style: inset;
line-height: 18px;
padding: 5px 5px;
}
table, table th, table td {
border-left-style: none;
border-right-style: none;
}
table thead, table tr.even {
background-color: #f7f7f7;
}
p {
margin: 0.5em 0;
}
blockquote {
background-color: #f6f6f6;
padding: 0.25em 0.75em;
}
hr {
border-style: solid;
border: none;
border-top: 1px solid #777;
margin: 28px 0;
}
dl {
margin-left: 0;
}
dl dd {
margin-bottom: 13px;
margin-left: 13px;
}
dl dt {
font-weight: bold;
}
ul {
margin-top: 0;
}
ul li {
list-style: circle outside;
}
ul ul {
margin-bottom: 0;
}
pre, code {
background-color: #f7f7f7;
border-radius: 3px;
color: #333;
white-space: pre-wrap; 
}
pre {
border-radius: 3px;
margin: 5px 0px 10px 0px;
padding: 10px;
}
pre:not([class]) {
background-color: #f7f7f7;
}
code {
font-family: Consolas, Monaco, 'Courier New', monospace;
font-size: 85%;
}
p > code, li > code {
padding: 2px 0px;
}
div.figure {
text-align: center;
}
img {
background-color: #FFFFFF;
padding: 2px;
border: 1px solid #DDDDDD;
border-radius: 3px;
border: 1px solid #CCCCCC;
margin: 0 5px;
}
h1 {
margin-top: 0;
font-size: 35px;
line-height: 40px;
}
h2 {
border-bottom: 4px solid #f7f7f7;
padding-top: 10px;
padding-bottom: 2px;
font-size: 145%;
}
h3 {
border-bottom: 2px solid #f7f7f7;
padding-top: 10px;
font-size: 120%;
}
h4 {
border-bottom: 1px solid #f7f7f7;
margin-left: 8px;
font-size: 105%;
}
h5, h6 {
border-bottom: 1px solid #ccc;
font-size: 105%;
}
a {
color: #0033dd;
text-decoration: none;
}
a:hover {
color: #6666ff; }
a:visited {
color: #800080; }
a:visited:hover {
color: #BB00BB; }
a[href^="http:"] {
text-decoration: underline; }
a[href^="https:"] {
text-decoration: underline; }

code > span.kw { color: #555; font-weight: bold; } 
code > span.dt { color: #902000; } 
code > span.dv { color: #40a070; } 
code > span.bn { color: #d14; } 
code > span.fl { color: #d14; } 
code > span.ch { color: #d14; } 
code > span.st { color: #d14; } 
code > span.co { color: #888888; font-style: italic; } 
code > span.ot { color: #007020; } 
code > span.al { color: #ff0000; font-weight: bold; } 
code > span.fu { color: #900; font-weight: bold; } 
code > span.er { color: #a61717; background-color: #e3d2d2; } 
</style>




</head>

<body>




<h1 class="title toc-ignore">Data Step Operations</h1>



<p>Normally, R processes data column-by-column. The data step allows you
to process data row-by-row. Row-by-row processing of data is useful when
you have related columns, and wish to perform conditional logic on those
columns. The <code>datastep()</code> function allows you to realize this
style of data processing. It is particularly advantageous when you wish
to perform deeply nested conditional logic. It is also very useful for
by-group processing.</p>
<div id="example-1-simple-data-step" class="section level4">
<h4>Example 1: Simple Data Step</h4>
<p>Here is an example of a simple data step:</p>
<div class="sourceCode" id="cb1"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb1-1"><a href="#cb1-1" tabindex="-1"></a><span class="fu">library</span>(libr)</span>
<span id="cb1-2"><a href="#cb1-2" tabindex="-1"></a></span>
<span id="cb1-3"><a href="#cb1-3" tabindex="-1"></a><span class="co"># Add some columns to mtcars using data step logic</span></span>
<span id="cb1-4"><a href="#cb1-4" tabindex="-1"></a>df <span class="ot">&lt;-</span> <span class="fu">datastep</span>(mtcars[<span class="dv">1</span><span class="sc">:</span><span class="dv">10</span>, <span class="dv">1</span><span class="sc">:</span><span class="dv">3</span>], {</span>
<span id="cb1-5"><a href="#cb1-5" tabindex="-1"></a></span>
<span id="cb1-6"><a href="#cb1-6" tabindex="-1"></a>    <span class="cf">if</span> (mpg <span class="sc">&gt;=</span> <span class="dv">20</span>) </span>
<span id="cb1-7"><a href="#cb1-7" tabindex="-1"></a>      mpgcat <span class="ot">&lt;-</span> <span class="st">&quot;High&quot;</span></span>
<span id="cb1-8"><a href="#cb1-8" tabindex="-1"></a>    <span class="cf">else</span> </span>
<span id="cb1-9"><a href="#cb1-9" tabindex="-1"></a>      mpgcat <span class="ot">&lt;-</span> <span class="st">&quot;Low&quot;</span></span>
<span id="cb1-10"><a href="#cb1-10" tabindex="-1"></a>      </span>
<span id="cb1-11"><a href="#cb1-11" tabindex="-1"></a>    recdt <span class="ot">&lt;-</span> <span class="fu">as.Date</span>(<span class="st">&quot;1974-06-10&quot;</span>)</span>
<span id="cb1-12"><a href="#cb1-12" tabindex="-1"></a>    </span>
<span id="cb1-13"><a href="#cb1-13" tabindex="-1"></a>    <span class="cf">if</span> (cyl <span class="sc">==</span> <span class="dv">8</span>)</span>
<span id="cb1-14"><a href="#cb1-14" tabindex="-1"></a>      is8cyl <span class="ot">&lt;-</span> <span class="cn">TRUE</span></span>
<span id="cb1-15"><a href="#cb1-15" tabindex="-1"></a></span>
<span id="cb1-16"><a href="#cb1-16" tabindex="-1"></a>  })</span>
<span id="cb1-17"><a href="#cb1-17" tabindex="-1"></a>  </span>
<span id="cb1-18"><a href="#cb1-18" tabindex="-1"></a><span class="co"># View results  </span></span>
<span id="cb1-19"><a href="#cb1-19" tabindex="-1"></a>df</span>
<span id="cb1-20"><a href="#cb1-20" tabindex="-1"></a><span class="co">#                    mpg cyl  disp      recdt mpgcat is8cyl</span></span>
<span id="cb1-21"><a href="#cb1-21" tabindex="-1"></a><span class="co"># Mazda RX4         21.0   6 160.0 1974-06-10   High     NA</span></span>
<span id="cb1-22"><a href="#cb1-22" tabindex="-1"></a><span class="co"># Mazda RX4 Wag     21.0   6 160.0 1974-06-10   High     NA</span></span>
<span id="cb1-23"><a href="#cb1-23" tabindex="-1"></a><span class="co"># Datsun 710        22.8   4 108.0 1974-06-10   High     NA</span></span>
<span id="cb1-24"><a href="#cb1-24" tabindex="-1"></a><span class="co"># Hornet 4 Drive    21.4   6 258.0 1974-06-10   High     NA</span></span>
<span id="cb1-25"><a href="#cb1-25" tabindex="-1"></a><span class="co"># Hornet Sportabout 18.7   8 360.0 1974-06-10    Low   TRUE</span></span>
<span id="cb1-26"><a href="#cb1-26" tabindex="-1"></a><span class="co"># Valiant           18.1   6 225.0 1974-06-10    Low     NA</span></span>
<span id="cb1-27"><a href="#cb1-27" tabindex="-1"></a><span class="co"># Duster 360        14.3   8 360.0 1974-06-10    Low   TRUE</span></span>
<span id="cb1-28"><a href="#cb1-28" tabindex="-1"></a><span class="co"># Merc 240D         24.4   4 146.7 1974-06-10   High     NA</span></span>
<span id="cb1-29"><a href="#cb1-29" tabindex="-1"></a><span class="co"># Merc 230          22.8   4 140.8 1974-06-10   High     NA</span></span>
<span id="cb1-30"><a href="#cb1-30" tabindex="-1"></a><span class="co"># Merc 280          19.2   6 167.6 1974-06-10    Low     NA</span></span></code></pre></div>
</div>
<div id="keep-drop-and-rename" class="section level3">
<h3>Keep, Drop, and Rename</h3>
<p>The data step has parameters to perform basic shaping of the
resulting data frame. These parameters are ‘keep’, ‘drop’, and ‘rename’.
For example, the above data step could have been performed by sending
all columns into the data step, and keeping only the desired columns.
Using the <code>keep</code> parameter also allows you to order the
resulting columns.</p>
<div id="example-2-keeping-data-step-variables" class="section level4">
<h4>Example 2: Keeping Data Step Variables</h4>
<div class="sourceCode" id="cb2"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb2-1"><a href="#cb2-1" tabindex="-1"></a><span class="fu">library</span>(libr)</span>
<span id="cb2-2"><a href="#cb2-2" tabindex="-1"></a></span>
<span id="cb2-3"><a href="#cb2-3" tabindex="-1"></a><span class="co"># Keep and order output columns </span></span>
<span id="cb2-4"><a href="#cb2-4" tabindex="-1"></a>df <span class="ot">&lt;-</span> <span class="fu">datastep</span>(mtcars[<span class="dv">1</span><span class="sc">:</span><span class="dv">10</span>,], </span>
<span id="cb2-5"><a href="#cb2-5" tabindex="-1"></a>  <span class="at">keep =</span> <span class="fu">c</span>(<span class="st">&quot;mpg&quot;</span>, <span class="st">&quot;cyl&quot;</span>, <span class="st">&quot;disp&quot;</span>, <span class="st">&quot;mpgcat&quot;</span>, <span class="st">&quot;recdt&quot;</span>), {</span>
<span id="cb2-6"><a href="#cb2-6" tabindex="-1"></a></span>
<span id="cb2-7"><a href="#cb2-7" tabindex="-1"></a>    <span class="cf">if</span> (mpg <span class="sc">&gt;=</span> <span class="dv">20</span>) </span>
<span id="cb2-8"><a href="#cb2-8" tabindex="-1"></a>      mpgcat <span class="ot">&lt;-</span> <span class="st">&quot;High&quot;</span></span>
<span id="cb2-9"><a href="#cb2-9" tabindex="-1"></a>    <span class="cf">else</span> </span>
<span id="cb2-10"><a href="#cb2-10" tabindex="-1"></a>      mpgcat <span class="ot">&lt;-</span> <span class="st">&quot;Low&quot;</span></span>
<span id="cb2-11"><a href="#cb2-11" tabindex="-1"></a>      </span>
<span id="cb2-12"><a href="#cb2-12" tabindex="-1"></a>    recdt <span class="ot">&lt;-</span> <span class="fu">as.Date</span>(<span class="st">&quot;1974-06-10&quot;</span>)</span>
<span id="cb2-13"><a href="#cb2-13" tabindex="-1"></a>    </span>
<span id="cb2-14"><a href="#cb2-14" tabindex="-1"></a>    <span class="cf">if</span> (cyl <span class="sc">==</span> <span class="dv">8</span>)</span>
<span id="cb2-15"><a href="#cb2-15" tabindex="-1"></a>      is8cyl <span class="ot">&lt;-</span> <span class="cn">TRUE</span></span>
<span id="cb2-16"><a href="#cb2-16" tabindex="-1"></a></span>
<span id="cb2-17"><a href="#cb2-17" tabindex="-1"></a>  })</span>
<span id="cb2-18"><a href="#cb2-18" tabindex="-1"></a>  </span>
<span id="cb2-19"><a href="#cb2-19" tabindex="-1"></a>df</span>
<span id="cb2-20"><a href="#cb2-20" tabindex="-1"></a><span class="co">#                    mpg cyl  disp mpgcat      recdt</span></span>
<span id="cb2-21"><a href="#cb2-21" tabindex="-1"></a><span class="co"># Mazda RX4         21.0   6 160.0   High 1974-06-10</span></span>
<span id="cb2-22"><a href="#cb2-22" tabindex="-1"></a><span class="co"># Mazda RX4 Wag     21.0   6 160.0   High 1974-06-10</span></span>
<span id="cb2-23"><a href="#cb2-23" tabindex="-1"></a><span class="co"># Datsun 710        22.8   4 108.0   High 1974-06-10</span></span>
<span id="cb2-24"><a href="#cb2-24" tabindex="-1"></a><span class="co"># Hornet 4 Drive    21.4   6 258.0   High 1974-06-10</span></span>
<span id="cb2-25"><a href="#cb2-25" tabindex="-1"></a><span class="co"># Hornet Sportabout 18.7   8 360.0    Low 1974-06-10</span></span>
<span id="cb2-26"><a href="#cb2-26" tabindex="-1"></a><span class="co"># Valiant           18.1   6 225.0    Low 1974-06-10</span></span>
<span id="cb2-27"><a href="#cb2-27" tabindex="-1"></a><span class="co"># Duster 360        14.3   8 360.0    Low 1974-06-10</span></span>
<span id="cb2-28"><a href="#cb2-28" tabindex="-1"></a><span class="co"># Merc 240D         24.4   4 146.7   High 1974-06-10</span></span>
<span id="cb2-29"><a href="#cb2-29" tabindex="-1"></a><span class="co"># Merc 230          22.8   4 140.8   High 1974-06-10</span></span>
<span id="cb2-30"><a href="#cb2-30" tabindex="-1"></a><span class="co"># Merc 280          19.2   6 167.6    Low 1974-06-10</span></span></code></pre></div>
</div>
</div>
<div id="the-retain-parameter" class="section level3">
<h3>The Retain Parameter</h3>
<p>The retain parameter allows you to define variables that will be
seeded with the value from the previous step. The retain option is
useful for creating cumulative values or for performing conditions based
on the value of the previous row.</p>
<div id="example-3-drop-retain-and-rename-parameters" class="section level4">
<h4>Example 3: Drop, Retain, and Rename Parameters</h4>
<div class="sourceCode" id="cb3"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb3-1"><a href="#cb3-1" tabindex="-1"></a><span class="fu">library</span>(libr)</span>
<span id="cb3-2"><a href="#cb3-2" tabindex="-1"></a></span>
<span id="cb3-3"><a href="#cb3-3" tabindex="-1"></a>df <span class="ot">&lt;-</span> <span class="fu">datastep</span>(mtcars[<span class="dv">1</span><span class="sc">:</span><span class="dv">10</span>, ],</span>
<span id="cb3-4"><a href="#cb3-4" tabindex="-1"></a>               <span class="at">drop =</span> <span class="fu">c</span>(<span class="st">&quot;disp&quot;</span>, <span class="st">&quot;hp&quot;</span>, <span class="st">&quot;drat&quot;</span>, <span class="st">&quot;qsec&quot;</span>,</span>
<span id="cb3-5"><a href="#cb3-5" tabindex="-1"></a>                        <span class="st">&quot;vs&quot;</span>, <span class="st">&quot;am&quot;</span>, <span class="st">&quot;gear&quot;</span>, <span class="st">&quot;carb&quot;</span>),</span>
<span id="cb3-6"><a href="#cb3-6" tabindex="-1"></a>               <span class="at">retain =</span> <span class="fu">list</span>(<span class="at">cumwt =</span> <span class="dv">0</span> ),</span>
<span id="cb3-7"><a href="#cb3-7" tabindex="-1"></a>               <span class="at">rename =</span> <span class="fu">c</span>(<span class="at">mpg =</span> <span class="st">&quot;MPG&quot;</span>, <span class="at">cyl =</span> <span class="st">&quot;Cylinders&quot;</span>, <span class="at">wt =</span> <span class="st">&quot;Wgt&quot;</span>,</span>
<span id="cb3-8"><a href="#cb3-8" tabindex="-1"></a>                          <span class="at">cumwt =</span> <span class="st">&quot;Cumulative Wgt&quot;</span>), {</span>
<span id="cb3-9"><a href="#cb3-9" tabindex="-1"></a></span>
<span id="cb3-10"><a href="#cb3-10" tabindex="-1"></a>  cumwt <span class="ot">&lt;-</span> cumwt <span class="sc">+</span> wt</span>
<span id="cb3-11"><a href="#cb3-11" tabindex="-1"></a></span>
<span id="cb3-12"><a href="#cb3-12" tabindex="-1"></a> })</span>
<span id="cb3-13"><a href="#cb3-13" tabindex="-1"></a></span>
<span id="cb3-14"><a href="#cb3-14" tabindex="-1"></a>df</span>
<span id="cb3-15"><a href="#cb3-15" tabindex="-1"></a><span class="co">#                    MPG Cylinders   Wgt Cumulative Wgt</span></span>
<span id="cb3-16"><a href="#cb3-16" tabindex="-1"></a><span class="co"># Mazda RX4         21.0         6 2.620          2.620</span></span>
<span id="cb3-17"><a href="#cb3-17" tabindex="-1"></a><span class="co"># Mazda RX4 Wag     21.0         6 2.875          5.495</span></span>
<span id="cb3-18"><a href="#cb3-18" tabindex="-1"></a><span class="co"># Datsun 710        22.8         4 2.320          7.815</span></span>
<span id="cb3-19"><a href="#cb3-19" tabindex="-1"></a><span class="co"># Hornet 4 Drive    21.4         6 3.215         11.030</span></span>
<span id="cb3-20"><a href="#cb3-20" tabindex="-1"></a><span class="co"># Hornet Sportabout 18.7         8 3.440         14.470</span></span>
<span id="cb3-21"><a href="#cb3-21" tabindex="-1"></a><span class="co"># Valiant           18.1         6 3.460         17.930</span></span>
<span id="cb3-22"><a href="#cb3-22" tabindex="-1"></a><span class="co"># Duster 360        14.3         8 3.570         21.500</span></span>
<span id="cb3-23"><a href="#cb3-23" tabindex="-1"></a><span class="co"># Merc 240D         24.4         4 3.190         24.690</span></span>
<span id="cb3-24"><a href="#cb3-24" tabindex="-1"></a><span class="co"># Merc 230          22.8         4 3.150         27.840</span></span>
<span id="cb3-25"><a href="#cb3-25" tabindex="-1"></a><span class="co"># Merc 280          19.2         6 3.440         31.280</span></span></code></pre></div>
</div>
</div>
<div id="by-group-processing" class="section level3">
<h3>By Group Processing</h3>
<p>The <code>datastep()</code> function also has the capabilities of
performing by-group processing. A by-group is accomplished using the
<code>by</code> parameter, and passing a vector of column names that
define the group. Once a by-group is defined, the <code>first.</code>
and <code>last.</code> automatic variables become active, which allow
you to identify the boundaries between groups. Note that, by default,
your data must be sorted properly before sending it into the data step.
To turn the sort check off, set the <code>sort_check</code> parameter to
FALSE.</p>
<div id="example-4-by-groups" class="section level4">
<h4>Example 4: By Groups</h4>
<div class="sourceCode" id="cb4"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb4-1"><a href="#cb4-1" tabindex="-1"></a><span class="fu">library</span>(libr)</span>
<span id="cb4-2"><a href="#cb4-2" tabindex="-1"></a></span>
<span id="cb4-3"><a href="#cb4-3" tabindex="-1"></a><span class="co"># Identify start and end of by-groups</span></span>
<span id="cb4-4"><a href="#cb4-4" tabindex="-1"></a>df <span class="ot">&lt;-</span> <span class="fu">datastep</span>(mtcars[<span class="dv">1</span><span class="sc">:</span><span class="dv">10</span>,], </span>
<span id="cb4-5"><a href="#cb4-5" tabindex="-1"></a>  <span class="at">keep =</span> <span class="fu">c</span>(<span class="st">&quot;mpg&quot;</span>, <span class="st">&quot;cyl&quot;</span>, <span class="st">&quot;gear&quot;</span>, <span class="st">&quot;grp&quot;</span>), </span>
<span id="cb4-6"><a href="#cb4-6" tabindex="-1"></a>  <span class="at">by =</span> <span class="fu">c</span>(<span class="st">&quot;gear&quot;</span>), <span class="at">sort_check =</span> <span class="cn">FALSE</span>, {</span>
<span id="cb4-7"><a href="#cb4-7" tabindex="-1"></a></span>
<span id="cb4-8"><a href="#cb4-8" tabindex="-1"></a>    <span class="cf">if</span> (first. <span class="sc">&amp;</span> last.)</span>
<span id="cb4-9"><a href="#cb4-9" tabindex="-1"></a>      grp <span class="ot">&lt;-</span> <span class="st">&quot;Start - End&quot;</span></span>
<span id="cb4-10"><a href="#cb4-10" tabindex="-1"></a>    <span class="cf">else</span> <span class="cf">if</span> (first.)</span>
<span id="cb4-11"><a href="#cb4-11" tabindex="-1"></a>      grp <span class="ot">&lt;-</span> <span class="st">&quot;Start&quot;</span></span>
<span id="cb4-12"><a href="#cb4-12" tabindex="-1"></a>    <span class="cf">else</span> <span class="cf">if</span> (last.)</span>
<span id="cb4-13"><a href="#cb4-13" tabindex="-1"></a>      grp <span class="ot">&lt;-</span> <span class="st">&quot;End&quot;</span></span>
<span id="cb4-14"><a href="#cb4-14" tabindex="-1"></a>    <span class="cf">else</span> </span>
<span id="cb4-15"><a href="#cb4-15" tabindex="-1"></a>      grp <span class="ot">&lt;-</span> <span class="st">&quot;-&quot;</span></span>
<span id="cb4-16"><a href="#cb4-16" tabindex="-1"></a></span>
<span id="cb4-17"><a href="#cb4-17" tabindex="-1"></a>  })</span>
<span id="cb4-18"><a href="#cb4-18" tabindex="-1"></a>  </span>
<span id="cb4-19"><a href="#cb4-19" tabindex="-1"></a>df</span>
<span id="cb4-20"><a href="#cb4-20" tabindex="-1"></a><span class="co">#                    mpg cyl gear   grp</span></span>
<span id="cb4-21"><a href="#cb4-21" tabindex="-1"></a><span class="co"># Mazda RX4         21.0   6    4 Start</span></span>
<span id="cb4-22"><a href="#cb4-22" tabindex="-1"></a><span class="co"># Mazda RX4 Wag     21.0   6    4     -</span></span>
<span id="cb4-23"><a href="#cb4-23" tabindex="-1"></a><span class="co"># Datsun 710        22.8   4    4   End</span></span>
<span id="cb4-24"><a href="#cb4-24" tabindex="-1"></a><span class="co"># Hornet 4 Drive    21.4   6    3 Start</span></span>
<span id="cb4-25"><a href="#cb4-25" tabindex="-1"></a><span class="co"># Hornet Sportabout 18.7   8    3     -</span></span>
<span id="cb4-26"><a href="#cb4-26" tabindex="-1"></a><span class="co"># Valiant           18.1   6    3     -</span></span>
<span id="cb4-27"><a href="#cb4-27" tabindex="-1"></a><span class="co"># Duster 360        14.3   8    3   End</span></span>
<span id="cb4-28"><a href="#cb4-28" tabindex="-1"></a><span class="co"># Merc 240D         24.4   4    4 Start</span></span>
<span id="cb4-29"><a href="#cb4-29" tabindex="-1"></a><span class="co"># Merc 230          22.8   4    4     -</span></span>
<span id="cb4-30"><a href="#cb4-30" tabindex="-1"></a><span class="co"># Merc 280          19.2   6    4   End</span></span></code></pre></div>
</div>
</div>
<div id="by-group-processing-of-multiple-variables" class="section level3">
<h3>By Group Processing of Multiple Variables</h3>
<p>If desired, you can pass multiple variables on the <code>by</code>
parameter. When there are multiple by groups, the <code>first.</code>
and <code>last.</code> automatic variables described above will
represent an “or” combination of values for all by-variables. In
addition, automatic variables will be created for each variable in the
by group, similar to SAS®. Observe:</p>
<div id="example-5-multiple-by-groups" class="section level4">
<h4>Example 5: Multiple By Groups</h4>
<div class="sourceCode" id="cb5"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb5-1"><a href="#cb5-1" tabindex="-1"></a><span class="fu">library</span>(libr)</span>
<span id="cb5-2"><a href="#cb5-2" tabindex="-1"></a></span>
<span id="cb5-3"><a href="#cb5-3" tabindex="-1"></a><span class="co"># Create sample data</span></span>
<span id="cb5-4"><a href="#cb5-4" tabindex="-1"></a>df <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(HairEyeColor)[<span class="fu">seq</span>(<span class="dv">2</span>, <span class="dv">32</span>, <span class="dv">2</span>), ]</span>
<span id="cb5-5"><a href="#cb5-5" tabindex="-1"></a></span>
<span id="cb5-6"><a href="#cb5-6" tabindex="-1"></a><span class="co"># Sort by groups</span></span>
<span id="cb5-7"><a href="#cb5-7" tabindex="-1"></a>df <span class="ot">&lt;-</span> <span class="fu">sort</span>(df, <span class="at">by =</span> <span class="fu">c</span>(<span class="st">&quot;Sex&quot;</span>, <span class="st">&quot;Hair&quot;</span>))</span>
<span id="cb5-8"><a href="#cb5-8" tabindex="-1"></a></span>
<span id="cb5-9"><a href="#cb5-9" tabindex="-1"></a><span class="co"># Identify start and end of by-groups</span></span>
<span id="cb5-10"><a href="#cb5-10" tabindex="-1"></a>df2 <span class="ot">&lt;-</span> <span class="fu">datastep</span>(df,</span>
<span id="cb5-11"><a href="#cb5-11" tabindex="-1"></a>   <span class="at">drop =</span> <span class="fu">c</span>(<span class="st">&quot;Eye&quot;</span>, <span class="st">&quot;Freq&quot;</span>),</span>
<span id="cb5-12"><a href="#cb5-12" tabindex="-1"></a>   <span class="at">by =</span> <span class="fu">c</span>(<span class="st">&quot;Sex&quot;</span>, <span class="st">&quot;Hair&quot;</span>), {</span>
<span id="cb5-13"><a href="#cb5-13" tabindex="-1"></a></span>
<span id="cb5-14"><a href="#cb5-14" tabindex="-1"></a>    fSex <span class="ot">&lt;-</span> first.Sex</span>
<span id="cb5-15"><a href="#cb5-15" tabindex="-1"></a>    lSex <span class="ot">&lt;-</span> last.Sex</span>
<span id="cb5-16"><a href="#cb5-16" tabindex="-1"></a>    fHair <span class="ot">&lt;-</span> first.Hair</span>
<span id="cb5-17"><a href="#cb5-17" tabindex="-1"></a>    lHair <span class="ot">&lt;-</span> last.Hair</span>
<span id="cb5-18"><a href="#cb5-18" tabindex="-1"></a></span>
<span id="cb5-19"><a href="#cb5-19" tabindex="-1"></a>  })</span>
<span id="cb5-20"><a href="#cb5-20" tabindex="-1"></a>  </span>
<span id="cb5-21"><a href="#cb5-21" tabindex="-1"></a>df2</span>
<span id="cb5-22"><a href="#cb5-22" tabindex="-1"></a><span class="co">#     Hair    Sex  fSex  lSex fHair lHair</span></span>
<span id="cb5-23"><a href="#cb5-23" tabindex="-1"></a><span class="co"># 1  Brown   Male  TRUE FALSE  TRUE FALSE</span></span>
<span id="cb5-24"><a href="#cb5-24" tabindex="-1"></a><span class="co"># 2  Brown   Male FALSE FALSE FALSE FALSE</span></span>
<span id="cb5-25"><a href="#cb5-25" tabindex="-1"></a><span class="co"># 3  Brown   Male FALSE FALSE FALSE FALSE</span></span>
<span id="cb5-26"><a href="#cb5-26" tabindex="-1"></a><span class="co"># 4  Brown   Male FALSE FALSE FALSE  TRUE</span></span>
<span id="cb5-27"><a href="#cb5-27" tabindex="-1"></a><span class="co"># 5  Blond   Male FALSE FALSE  TRUE FALSE</span></span>
<span id="cb5-28"><a href="#cb5-28" tabindex="-1"></a><span class="co"># 6  Blond   Male FALSE FALSE FALSE FALSE</span></span>
<span id="cb5-29"><a href="#cb5-29" tabindex="-1"></a><span class="co"># 7  Blond   Male FALSE FALSE FALSE FALSE</span></span>
<span id="cb5-30"><a href="#cb5-30" tabindex="-1"></a><span class="co"># 8  Blond   Male FALSE  TRUE FALSE  TRUE</span></span>
<span id="cb5-31"><a href="#cb5-31" tabindex="-1"></a><span class="co"># 9  Brown Female  TRUE FALSE  TRUE FALSE</span></span>
<span id="cb5-32"><a href="#cb5-32" tabindex="-1"></a><span class="co"># 10 Brown Female FALSE FALSE FALSE FALSE</span></span>
<span id="cb5-33"><a href="#cb5-33" tabindex="-1"></a><span class="co"># 11 Brown Female FALSE FALSE FALSE FALSE</span></span>
<span id="cb5-34"><a href="#cb5-34" tabindex="-1"></a><span class="co"># 12 Brown Female FALSE FALSE FALSE  TRUE</span></span>
<span id="cb5-35"><a href="#cb5-35" tabindex="-1"></a><span class="co"># 13 Blond Female FALSE FALSE  TRUE FALSE</span></span>
<span id="cb5-36"><a href="#cb5-36" tabindex="-1"></a><span class="co"># 14 Blond Female FALSE FALSE FALSE FALSE</span></span>
<span id="cb5-37"><a href="#cb5-37" tabindex="-1"></a><span class="co"># 15 Blond Female FALSE FALSE FALSE FALSE</span></span>
<span id="cb5-38"><a href="#cb5-38" tabindex="-1"></a><span class="co"># 16 Blond Female FALSE  TRUE FALSE  TRUE</span></span></code></pre></div>
<p>The above <code>first.Sex</code>, <code>last.Sex</code>,
<code>first.Hair</code>, and <code>last.Hair</code> variables may also
be used in conditions, functions, or any other expression inside your
datastep. Note that like <code>first.</code> and <code>last.</code> they
are dropped automatically at the end of the datastep. If you want to
retain their values, assign them to a new variable as shown above.</p>
</div>
</div>
<div id="using-summary-functions" class="section level3">
<h3>Using Summary Functions</h3>
<p>There may be times when you want to combine row-by-row conditional
processing with column-by-column vector operations. For example, let’s
say you want to calculate a mean and then perform conditional processing
on that mean. This situation can be handled using the
<code>calculate</code> parameter on the <code>datastep()</code>
function. The function will execute the <code>calculate</code> block
first, add any assigned variables to the data frame, and then execute
the data step. Below is an example of such a scenario:</p>
<div id="example-6-calculate-block" class="section level4">
<h4>Example 6: Calculate Block</h4>
<div class="sourceCode" id="cb6"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb6-1"><a href="#cb6-1" tabindex="-1"></a><span class="fu">library</span>(libr)</span>
<span id="cb6-2"><a href="#cb6-2" tabindex="-1"></a></span>
<span id="cb6-3"><a href="#cb6-3" tabindex="-1"></a><span class="co"># Categorize mpg as above or below the mean</span></span>
<span id="cb6-4"><a href="#cb6-4" tabindex="-1"></a>df <span class="ot">&lt;-</span> <span class="fu">datastep</span>(mtcars, </span>
<span id="cb6-5"><a href="#cb6-5" tabindex="-1"></a>  <span class="at">keep =</span> <span class="fu">c</span>(<span class="st">&quot;mpg&quot;</span>, <span class="st">&quot;cyl&quot;</span>, <span class="st">&quot;mean_mpg&quot;</span>, <span class="st">&quot;mpgcat&quot;</span>), </span>
<span id="cb6-6"><a href="#cb6-6" tabindex="-1"></a>  <span class="at">calculate =</span> { mean_mpg <span class="ot">=</span> <span class="fu">mean</span>(mpg) },</span>
<span id="cb6-7"><a href="#cb6-7" tabindex="-1"></a>  {</span>
<span id="cb6-8"><a href="#cb6-8" tabindex="-1"></a></span>
<span id="cb6-9"><a href="#cb6-9" tabindex="-1"></a>    <span class="cf">if</span> (mpg <span class="sc">&gt;=</span> mean_mpg)</span>
<span id="cb6-10"><a href="#cb6-10" tabindex="-1"></a>      mpgcat <span class="ot">&lt;-</span> <span class="st">&quot;High&quot;</span></span>
<span id="cb6-11"><a href="#cb6-11" tabindex="-1"></a>    <span class="cf">else</span> </span>
<span id="cb6-12"><a href="#cb6-12" tabindex="-1"></a>      mpgcat <span class="ot">&lt;-</span> <span class="st">&quot;Low&quot;</span></span>
<span id="cb6-13"><a href="#cb6-13" tabindex="-1"></a></span>
<span id="cb6-14"><a href="#cb6-14" tabindex="-1"></a>  })</span>
<span id="cb6-15"><a href="#cb6-15" tabindex="-1"></a>  </span>
<span id="cb6-16"><a href="#cb6-16" tabindex="-1"></a>df[<span class="dv">1</span><span class="sc">:</span><span class="dv">10</span>,]</span>
<span id="cb6-17"><a href="#cb6-17" tabindex="-1"></a><span class="co">#                    mpg cyl mean_mpg mpgcat</span></span>
<span id="cb6-18"><a href="#cb6-18" tabindex="-1"></a><span class="co"># Mazda RX4         21.0   6 20.09062   High</span></span>
<span id="cb6-19"><a href="#cb6-19" tabindex="-1"></a><span class="co"># Mazda RX4 Wag     21.0   6 20.09062   High</span></span>
<span id="cb6-20"><a href="#cb6-20" tabindex="-1"></a><span class="co"># Datsun 710        22.8   4 20.09062   High</span></span>
<span id="cb6-21"><a href="#cb6-21" tabindex="-1"></a><span class="co"># Hornet 4 Drive    21.4   6 20.09062   High</span></span>
<span id="cb6-22"><a href="#cb6-22" tabindex="-1"></a><span class="co"># Hornet Sportabout 18.7   8 20.09062    Low</span></span>
<span id="cb6-23"><a href="#cb6-23" tabindex="-1"></a><span class="co"># Valiant           18.1   6 20.09062    Low</span></span>
<span id="cb6-24"><a href="#cb6-24" tabindex="-1"></a><span class="co"># Duster 360        14.3   8 20.09062    Low</span></span>
<span id="cb6-25"><a href="#cb6-25" tabindex="-1"></a><span class="co"># Merc 240D         24.4   4 20.09062   High</span></span>
<span id="cb6-26"><a href="#cb6-26" tabindex="-1"></a><span class="co"># Merc 230          22.8   4 20.09062   High</span></span>
<span id="cb6-27"><a href="#cb6-27" tabindex="-1"></a><span class="co"># Merc 280          19.2   6 20.09062    Low</span></span></code></pre></div>
</div>
</div>
<div id="data-steps-with-dplyr" class="section level3">
<h3>Data Steps with <code>dplyr</code></h3>
<p>Note that the <code>datastep()</code> function is pipe-friendly, and
can be combined with <strong>dplyr</strong> functions in a data
pipeline. Also note that the <code>datastep()</code> function will
recognize any group attributes added by the <code>group_by()</code>
function. Therefore, within a <strong>dplyr</strong> pipeline, it is not
necessary to use any <code>datastep</code> parameters. The following
example recreates the above data frame from Example 5, but with a
<strong>dplyr</strong> pipeline.</p>
<div id="example-7-data-pipeline" class="section level4">
<h4>Example 7: Data Pipeline</h4>
<div class="sourceCode" id="cb7"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb7-1"><a href="#cb7-1" tabindex="-1"></a><span class="fu">library</span>(libr)</span>
<span id="cb7-2"><a href="#cb7-2" tabindex="-1"></a><span class="fu">library</span>(dplyr)</span>
<span id="cb7-3"><a href="#cb7-3" tabindex="-1"></a><span class="fu">library</span>(magrittr)</span>
<span id="cb7-4"><a href="#cb7-4" tabindex="-1"></a></span>
<span id="cb7-5"><a href="#cb7-5" tabindex="-1"></a><span class="co"># Add datastep to dplyr pipeline</span></span>
<span id="cb7-6"><a href="#cb7-6" tabindex="-1"></a>df <span class="ot">&lt;-</span> mtcars <span class="sc">%&gt;%</span> </span>
<span id="cb7-7"><a href="#cb7-7" tabindex="-1"></a>  <span class="fu">select</span>(mpg, cyl, gear) <span class="sc">%&gt;%</span> </span>
<span id="cb7-8"><a href="#cb7-8" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">mean_mpg =</span> <span class="fu">mean</span>(mpg)) <span class="sc">%&gt;%</span> </span>
<span id="cb7-9"><a href="#cb7-9" tabindex="-1"></a>  <span class="fu">datastep</span>({</span>
<span id="cb7-10"><a href="#cb7-10" tabindex="-1"></a></span>
<span id="cb7-11"><a href="#cb7-11" tabindex="-1"></a>    <span class="cf">if</span> (mpg <span class="sc">&gt;=</span> mean_mpg)</span>
<span id="cb7-12"><a href="#cb7-12" tabindex="-1"></a>      mpgcat <span class="ot">&lt;-</span> <span class="st">&quot;High&quot;</span></span>
<span id="cb7-13"><a href="#cb7-13" tabindex="-1"></a>    <span class="cf">else</span> </span>
<span id="cb7-14"><a href="#cb7-14" tabindex="-1"></a>      mpgcat <span class="ot">&lt;-</span> <span class="st">&quot;Low&quot;</span></span>
<span id="cb7-15"><a href="#cb7-15" tabindex="-1"></a></span>
<span id="cb7-16"><a href="#cb7-16" tabindex="-1"></a>  }) <span class="sc">%&gt;%</span> </span>
<span id="cb7-17"><a href="#cb7-17" tabindex="-1"></a>  <span class="fu">filter</span>(<span class="fu">row_number</span>() <span class="sc">&lt;=</span> <span class="dv">10</span>)</span>
<span id="cb7-18"><a href="#cb7-18" tabindex="-1"></a>  </span>
<span id="cb7-19"><a href="#cb7-19" tabindex="-1"></a>df</span>
<span id="cb7-20"><a href="#cb7-20" tabindex="-1"></a><span class="co">#     mpg cyl gear mean_mpg mpgcat</span></span>
<span id="cb7-21"><a href="#cb7-21" tabindex="-1"></a><span class="co"># 1  21.0   6    4 20.09062   High</span></span>
<span id="cb7-22"><a href="#cb7-22" tabindex="-1"></a><span class="co"># 2  21.0   6    4 20.09062   High</span></span>
<span id="cb7-23"><a href="#cb7-23" tabindex="-1"></a><span class="co"># 3  22.8   4    4 20.09062   High</span></span>
<span id="cb7-24"><a href="#cb7-24" tabindex="-1"></a><span class="co"># 4  21.4   6    3 20.09062   High</span></span>
<span id="cb7-25"><a href="#cb7-25" tabindex="-1"></a><span class="co"># 5  18.7   8    3 20.09062    Low</span></span>
<span id="cb7-26"><a href="#cb7-26" tabindex="-1"></a><span class="co"># 6  18.1   6    3 20.09062    Low</span></span>
<span id="cb7-27"><a href="#cb7-27" tabindex="-1"></a><span class="co"># 7  14.3   8    3 20.09062    Low</span></span>
<span id="cb7-28"><a href="#cb7-28" tabindex="-1"></a><span class="co"># 8  24.4   4    4 20.09062   High</span></span>
<span id="cb7-29"><a href="#cb7-29" tabindex="-1"></a><span class="co"># 9  22.8   4    4 20.09062   High</span></span>
<span id="cb7-30"><a href="#cb7-30" tabindex="-1"></a><span class="co"># 10 19.2   6    4 20.09062    Low</span></span></code></pre></div>
</div>
</div>
<div id="data-attributes" class="section level3">
<h3>Data Attributes</h3>
<p>The <strong>libr</strong> package recognizes several useful data
attributes that are not normally recognized by other R functions. For
example, it is very convenient to assign <em>label</em> and
<em>description</em> attributes to your columns, so other people can
understand what data the columns contain.</p>
<p>For this reason, the <code>datastep()</code> function provides an
<em>attrib</em> parameter that allows you to supply such attributes as
part of a data step. Attributes are assigned with a named list and the
<code>dsattr()</code> object.</p>
<div id="example-8-attributes" class="section level4">
<h4>Example 8: Attributes</h4>
<div class="sourceCode" id="cb8"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb8-1"><a href="#cb8-1" tabindex="-1"></a><span class="fu">library</span>(libr)</span>
<span id="cb8-2"><a href="#cb8-2" tabindex="-1"></a></span>
<span id="cb8-3"><a href="#cb8-3" tabindex="-1"></a><span class="co"># Assign label attributes to all columns</span></span>
<span id="cb8-4"><a href="#cb8-4" tabindex="-1"></a>df <span class="ot">&lt;-</span> <span class="fu">datastep</span>(mtcars[<span class="dv">1</span><span class="sc">:</span><span class="dv">10</span>, ], </span>
<span id="cb8-5"><a href="#cb8-5" tabindex="-1"></a>               <span class="at">keep =</span> <span class="fu">c</span>(<span class="st">&quot;mpg&quot;</span>, <span class="st">&quot;cyl&quot;</span>, <span class="st">&quot;mpgcat&quot;</span>),</span>
<span id="cb8-6"><a href="#cb8-6" tabindex="-1"></a>               <span class="at">calculate =</span> { mean_mpg <span class="ot">=</span> <span class="fu">mean</span>(mpg) },</span>
<span id="cb8-7"><a href="#cb8-7" tabindex="-1"></a>               <span class="at">attrib =</span> <span class="fu">list</span>(<span class="at">mpg =</span> <span class="fu">dsattr</span>(<span class="at">label =</span> <span class="st">&quot;Miles Per Gallon&quot;</span>),</span>
<span id="cb8-8"><a href="#cb8-8" tabindex="-1"></a>                             <span class="at">cyl =</span> <span class="fu">dsattr</span>(<span class="at">label =</span> <span class="st">&quot;Cylinders&quot;</span>),</span>
<span id="cb8-9"><a href="#cb8-9" tabindex="-1"></a>                             <span class="at">mpgcat =</span> <span class="fu">dsattr</span>(<span class="at">label =</span> <span class="st">&quot;Mileage Category&quot;</span>)), {</span>
<span id="cb8-10"><a href="#cb8-10" tabindex="-1"></a></span>
<span id="cb8-11"><a href="#cb8-11" tabindex="-1"></a>    <span class="cf">if</span> (mpg <span class="sc">&gt;=</span> mean_mpg)</span>
<span id="cb8-12"><a href="#cb8-12" tabindex="-1"></a>      mpgcat <span class="ot">&lt;-</span> <span class="st">&quot;High&quot;</span></span>
<span id="cb8-13"><a href="#cb8-13" tabindex="-1"></a>    <span class="cf">else</span> </span>
<span id="cb8-14"><a href="#cb8-14" tabindex="-1"></a>      mpgcat <span class="ot">&lt;-</span> <span class="st">&quot;Low&quot;</span></span>
<span id="cb8-15"><a href="#cb8-15" tabindex="-1"></a></span>
<span id="cb8-16"><a href="#cb8-16" tabindex="-1"></a>  }) </span>
<span id="cb8-17"><a href="#cb8-17" tabindex="-1"></a></span>
<span id="cb8-18"><a href="#cb8-18" tabindex="-1"></a><span class="co"># View attributes in dictionary</span></span>
<span id="cb8-19"><a href="#cb8-19" tabindex="-1"></a><span class="fu">dictionary</span>(df)</span>
<span id="cb8-20"><a href="#cb8-20" tabindex="-1"></a><span class="co"># # A tibble: 3 x 10</span></span>
<span id="cb8-21"><a href="#cb8-21" tabindex="-1"></a><span class="co">#   Name  Column Class     Label            Description Format Width Justify  Rows   NAs</span></span>
<span id="cb8-22"><a href="#cb8-22" tabindex="-1"></a><span class="co">#   &lt;chr&gt; &lt;chr&gt;  &lt;chr&gt;     &lt;chr&gt;            &lt;chr&gt;       &lt;lgl&gt;  &lt;int&gt; &lt;chr&gt;   &lt;int&gt; &lt;int&gt;</span></span>
<span id="cb8-23"><a href="#cb8-23" tabindex="-1"></a><span class="co"># 1 df    mpg    numeric   Miles Per Gallon NA          NA        NA NA         10     0</span></span>
<span id="cb8-24"><a href="#cb8-24" tabindex="-1"></a><span class="co"># 2 df    cyl    numeric   Cylinders        NA          NA        NA NA         10     0</span></span>
<span id="cb8-25"><a href="#cb8-25" tabindex="-1"></a><span class="co"># 3 df    mpgcat character Mileage Category NA          NA         4 NA         10     0</span></span></code></pre></div>
</div>
</div>
<div id="data-step-array" class="section level3">
<h3>Data Step Array</h3>
<p>As mentioned previously, R typically operates in a column-wise
manner. That is, R processes data column-by-column. But what if you need
to get a sum or mean across a row?</p>
<p>This situation is what led to the development of the <strong>data
step array</strong>. The data step array allows you to define a list of
columns and<br />
iterate over the list inside a data step. Data step arrays are defined
with the <em>arrays</em> parameter, which accepts a named list of
<code>dsarray()</code> objects.</p>
<p>To see the array in action, we’ll use the <em>AirPassengers</em>
sample data. This data shows international airline passengers by month
between 1949 and 1960. The data looks like this:</p>
<div class="sourceCode" id="cb9"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb9-1"><a href="#cb9-1" tabindex="-1"></a>AirPassengers</span>
<span id="cb9-2"><a href="#cb9-2" tabindex="-1"></a><span class="co">#      Jan Feb Mar Apr May Jun Jul Aug Sep Oct Nov Dec</span></span>
<span id="cb9-3"><a href="#cb9-3" tabindex="-1"></a><span class="co"># 1949 112 118 132 129 121 135 148 148 136 119 104 118</span></span>
<span id="cb9-4"><a href="#cb9-4" tabindex="-1"></a><span class="co"># 1950 115 126 141 135 125 149 170 170 158 133 114 140</span></span>
<span id="cb9-5"><a href="#cb9-5" tabindex="-1"></a><span class="co"># 1951 145 150 178 163 172 178 199 199 184 162 146 166</span></span>
<span id="cb9-6"><a href="#cb9-6" tabindex="-1"></a><span class="co"># 1952 171 180 193 181 183 218 230 242 209 191 172 194</span></span>
<span id="cb9-7"><a href="#cb9-7" tabindex="-1"></a><span class="co"># 1953 196 196 236 235 229 243 264 272 237 211 180 201</span></span>
<span id="cb9-8"><a href="#cb9-8" tabindex="-1"></a><span class="co"># 1954 204 188 235 227 234 264 302 293 259 229 203 229</span></span>
<span id="cb9-9"><a href="#cb9-9" tabindex="-1"></a><span class="co"># 1955 242 233 267 269 270 315 364 347 312 274 237 278</span></span>
<span id="cb9-10"><a href="#cb9-10" tabindex="-1"></a><span class="co"># 1956 284 277 317 313 318 374 413 405 355 306 271 306</span></span>
<span id="cb9-11"><a href="#cb9-11" tabindex="-1"></a><span class="co"># 1957 315 301 356 348 355 422 465 467 404 347 305 336</span></span>
<span id="cb9-12"><a href="#cb9-12" tabindex="-1"></a><span class="co"># 1958 340 318 362 348 363 435 491 505 404 359 310 337</span></span>
<span id="cb9-13"><a href="#cb9-13" tabindex="-1"></a><span class="co"># 1959 360 342 406 396 420 472 548 559 463 407 362 405</span></span>
<span id="cb9-14"><a href="#cb9-14" tabindex="-1"></a><span class="co"># 1960 417 391 419 461 472 535 622 606 508 461 390 432</span></span></code></pre></div>
<p>This example illustrates how to create row totals, row means, and
find the top month using a data step array. The array has an indexer to
extract values. You can use the indexer to extract a single value or a
subset of values. An empty indexer will return all the values in the
array.</p>
<div id="example-9-using-a-data-step-array" class="section level4">
<h4>Example 9: Using a Data Step Array</h4>
<div class="sourceCode" id="cb10"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb10-1"><a href="#cb10-1" tabindex="-1"></a><span class="fu">library</span>(libr)</span>
<span id="cb10-2"><a href="#cb10-2" tabindex="-1"></a></span>
<span id="cb10-3"><a href="#cb10-3" tabindex="-1"></a><span class="co"># Create AirPassengers Data Frame</span></span>
<span id="cb10-4"><a href="#cb10-4" tabindex="-1"></a>df <span class="ot">&lt;-</span> <span class="fu">as.data.frame</span>(<span class="fu">t</span>(<span class="fu">matrix</span>(AirPassengers, <span class="dv">12</span>,</span>
<span id="cb10-5"><a href="#cb10-5" tabindex="-1"></a>                    <span class="at">dimnames =</span> <span class="fu">list</span>(month.abb, <span class="fu">seq</span>(<span class="dv">1949</span>, <span class="dv">1960</span>)))), </span>
<span id="cb10-6"><a href="#cb10-6" tabindex="-1"></a>                    <span class="at">stringsAsFactors =</span> <span class="cn">FALSE</span>)</span>
<span id="cb10-7"><a href="#cb10-7" tabindex="-1"></a></span>
<span id="cb10-8"><a href="#cb10-8" tabindex="-1"></a><span class="co"># Use datastep array to get year tot, mean, and top month</span></span>
<span id="cb10-9"><a href="#cb10-9" tabindex="-1"></a>dat <span class="ot">&lt;-</span> <span class="fu">datastep</span>(df,</span>
<span id="cb10-10"><a href="#cb10-10" tabindex="-1"></a>                <span class="at">arrays =</span> <span class="fu">list</span>(<span class="at">months =</span> <span class="fu">dsarray</span>(<span class="fu">names</span>(df))),</span>
<span id="cb10-11"><a href="#cb10-11" tabindex="-1"></a>                <span class="at">attrib =</span> <span class="fu">list</span>(<span class="at">Tot =</span> <span class="dv">0</span>, <span class="at">Mean =</span> <span class="dv">0</span>, <span class="at">Top =</span> <span class="st">&quot;&quot;</span>),</span>
<span id="cb10-12"><a href="#cb10-12" tabindex="-1"></a>                <span class="at">drop =</span> <span class="st">&quot;mth&quot;</span>,</span>
<span id="cb10-13"><a href="#cb10-13" tabindex="-1"></a>                {</span>
<span id="cb10-14"><a href="#cb10-14" tabindex="-1"></a></span>
<span id="cb10-15"><a href="#cb10-15" tabindex="-1"></a>                  Tot <span class="ot">&lt;-</span> <span class="fu">sum</span>(months[])</span>
<span id="cb10-16"><a href="#cb10-16" tabindex="-1"></a>                  Mean <span class="ot">&lt;-</span> <span class="fu">mean</span>(months[])</span>
<span id="cb10-17"><a href="#cb10-17" tabindex="-1"></a></span>
<span id="cb10-18"><a href="#cb10-18" tabindex="-1"></a>                  <span class="cf">for</span> (mth <span class="cf">in</span> months) {</span>
<span id="cb10-19"><a href="#cb10-19" tabindex="-1"></a>                    <span class="cf">if</span> (months[mth] <span class="sc">==</span> <span class="fu">max</span>(months[])) {</span>
<span id="cb10-20"><a href="#cb10-20" tabindex="-1"></a>                      Top <span class="ot">&lt;-</span> mth</span>
<span id="cb10-21"><a href="#cb10-21" tabindex="-1"></a>                    }</span>
<span id="cb10-22"><a href="#cb10-22" tabindex="-1"></a>                  }</span>
<span id="cb10-23"><a href="#cb10-23" tabindex="-1"></a>                })</span>
<span id="cb10-24"><a href="#cb10-24" tabindex="-1"></a></span>
<span id="cb10-25"><a href="#cb10-25" tabindex="-1"></a></span>
<span id="cb10-26"><a href="#cb10-26" tabindex="-1"></a>dat</span>
<span id="cb10-27"><a href="#cb10-27" tabindex="-1"></a><span class="co">#      Jan Feb Mar Apr May Jun Jul Aug Sep Oct Nov Dec  Tot     Mean Top</span></span>
<span id="cb10-28"><a href="#cb10-28" tabindex="-1"></a><span class="co"># 1949 112 118 132 129 121 135 148 148 136 119 104 118 1520 126.6667 Aug</span></span>
<span id="cb10-29"><a href="#cb10-29" tabindex="-1"></a><span class="co"># 1950 115 126 141 135 125 149 170 170 158 133 114 140 1676 139.6667 Aug</span></span>
<span id="cb10-30"><a href="#cb10-30" tabindex="-1"></a><span class="co"># 1951 145 150 178 163 172 178 199 199 184 162 146 166 2042 170.1667 Aug</span></span>
<span id="cb10-31"><a href="#cb10-31" tabindex="-1"></a><span class="co"># 1952 171 180 193 181 183 218 230 242 209 191 172 194 2364 197.0000 Aug</span></span>
<span id="cb10-32"><a href="#cb10-32" tabindex="-1"></a><span class="co"># 1953 196 196 236 235 229 243 264 272 237 211 180 201 2700 225.0000 Aug</span></span>
<span id="cb10-33"><a href="#cb10-33" tabindex="-1"></a><span class="co"># 1954 204 188 235 227 234 264 302 293 259 229 203 229 2867 238.9167 Jul</span></span>
<span id="cb10-34"><a href="#cb10-34" tabindex="-1"></a><span class="co"># 1955 242 233 267 269 270 315 364 347 312 274 237 278 3408 284.0000 Jul</span></span>
<span id="cb10-35"><a href="#cb10-35" tabindex="-1"></a><span class="co"># 1956 284 277 317 313 318 374 413 405 355 306 271 306 3939 328.2500 Jul</span></span>
<span id="cb10-36"><a href="#cb10-36" tabindex="-1"></a><span class="co"># 1957 315 301 356 348 355 422 465 467 404 347 305 336 4421 368.4167 Aug</span></span>
<span id="cb10-37"><a href="#cb10-37" tabindex="-1"></a><span class="co"># 1958 340 318 362 348 363 435 491 505 404 359 310 337 4572 381.0000 Aug</span></span>
<span id="cb10-38"><a href="#cb10-38" tabindex="-1"></a><span class="co"># 1959 360 342 406 396 420 472 548 559 463 407 362 405 5140 428.3333 Aug</span></span>
<span id="cb10-39"><a href="#cb10-39" tabindex="-1"></a><span class="co"># 1960 417 391 419 461 472 535 622 606 508 461 390 432 5714 476.1667 Jul</span></span></code></pre></div>
<p>In the example above, the “Tot”, “Mean”, and “Top” columns were all
calculated using the datastep array. These types of row-wise statistics
are hard to calculate otherwise.</p>
</div>
</div>
<div id="filtering-and-duplicating-rows" class="section level3">
<h3>Filtering and Duplicating Rows</h3>
<p>The datastep provides different ways to control which rows are
output.</p>
<p>First, the function has a <code>where</code> parameter to pass a
filter expression to the datastep. The where clause will be executed at
the end of datastep processing. Pass in the where clause using the
<code>expression()</code> function. Like so:</p>
<div class="sourceCode" id="cb11"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb11-1"><a href="#cb11-1" tabindex="-1"></a><span class="co"># Prepare sample data</span></span>
<span id="cb11-2"><a href="#cb11-2" tabindex="-1"></a>dat <span class="ot">&lt;-</span> <span class="fu">as.data.frame</span>(HairEyeColor)</span>
<span id="cb11-3"><a href="#cb11-3" tabindex="-1"></a></span>
<span id="cb11-4"><a href="#cb11-4" tabindex="-1"></a><span class="co"># Filter for black hair and blue eyes</span></span>
<span id="cb11-5"><a href="#cb11-5" tabindex="-1"></a>res <span class="ot">&lt;-</span> <span class="fu">datastep</span>(dat, </span>
<span id="cb11-6"><a href="#cb11-6" tabindex="-1"></a>                <span class="at">where =</span> <span class="fu">expression</span>(Hair <span class="sc">==</span> <span class="st">&quot;Black&quot;</span> <span class="sc">&amp;</span> Eye <span class="sc">==</span> <span class="st">&quot;Blue&quot;</span>), </span>
<span id="cb11-7"><a href="#cb11-7" tabindex="-1"></a>                {})</span>
<span id="cb11-8"><a href="#cb11-8" tabindex="-1"></a></span>
<span id="cb11-9"><a href="#cb11-9" tabindex="-1"></a>res</span>
<span id="cb11-10"><a href="#cb11-10" tabindex="-1"></a><span class="co">#    Hair  Eye    Sex Freq</span></span>
<span id="cb11-11"><a href="#cb11-11" tabindex="-1"></a><span class="co"># 1 Black Blue   Male   11</span></span>
<span id="cb11-12"><a href="#cb11-12" tabindex="-1"></a><span class="co"># 2 Black Blue Female    9</span></span></code></pre></div>
<p>The datastep also recognizes the <code>delete()</code> and
<code>output()</code> functions to remove or duplicate rows from inside
the datastep. These functions give you conditional control over which
rows are output.</p>
<div class="sourceCode" id="cb12"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb12-1"><a href="#cb12-1" tabindex="-1"></a><span class="co"># Delete rows with frequencies less than 25</span></span>
<span id="cb12-2"><a href="#cb12-2" tabindex="-1"></a>res1 <span class="ot">&lt;-</span> <span class="fu">datastep</span>(dat, {</span>
<span id="cb12-3"><a href="#cb12-3" tabindex="-1"></a>  </span>
<span id="cb12-4"><a href="#cb12-4" tabindex="-1"></a>         <span class="cf">if</span> (Freq <span class="sc">&lt;</span> <span class="dv">25</span>)</span>
<span id="cb12-5"><a href="#cb12-5" tabindex="-1"></a>           <span class="fu">delete</span>()</span>
<span id="cb12-6"><a href="#cb12-6" tabindex="-1"></a>  </span>
<span id="cb12-7"><a href="#cb12-7" tabindex="-1"></a>       })</span>
<span id="cb12-8"><a href="#cb12-8" tabindex="-1"></a>res1</span>
<span id="cb12-9"><a href="#cb12-9" tabindex="-1"></a><span class="co">#     Hair   Eye    Sex Freq</span></span>
<span id="cb12-10"><a href="#cb12-10" tabindex="-1"></a><span class="co"># 1  Black Brown   Male   32</span></span>
<span id="cb12-11"><a href="#cb12-11" tabindex="-1"></a><span class="co"># 2  Brown Brown   Male   53</span></span>
<span id="cb12-12"><a href="#cb12-12" tabindex="-1"></a><span class="co"># 3  Brown  Blue   Male   50</span></span>
<span id="cb12-13"><a href="#cb12-13" tabindex="-1"></a><span class="co"># 4  Blond  Blue   Male   30</span></span>
<span id="cb12-14"><a href="#cb12-14" tabindex="-1"></a><span class="co"># 5  Brown Hazel   Male   25</span></span>
<span id="cb12-15"><a href="#cb12-15" tabindex="-1"></a><span class="co"># 6  Black Brown Female   36</span></span>
<span id="cb12-16"><a href="#cb12-16" tabindex="-1"></a><span class="co"># 7  Brown Brown Female   66</span></span>
<span id="cb12-17"><a href="#cb12-17" tabindex="-1"></a><span class="co"># 8  Brown  Blue Female   34</span></span>
<span id="cb12-18"><a href="#cb12-18" tabindex="-1"></a><span class="co"># 9  Blond  Blue Female   64</span></span>
<span id="cb12-19"><a href="#cb12-19" tabindex="-1"></a><span class="co"># 10 Brown Hazel Female   29</span></span>
<span id="cb12-20"><a href="#cb12-20" tabindex="-1"></a></span>
<span id="cb12-21"><a href="#cb12-21" tabindex="-1"></a><span class="co"># Only output rows for brown-eyes and frequencies over 25</span></span>
<span id="cb12-22"><a href="#cb12-22" tabindex="-1"></a>res2 <span class="ot">&lt;-</span> <span class="fu">datastep</span>(dat, {</span>
<span id="cb12-23"><a href="#cb12-23" tabindex="-1"></a>          </span>
<span id="cb12-24"><a href="#cb12-24" tabindex="-1"></a>          <span class="cf">if</span> (Eye <span class="sc">==</span> <span class="st">&quot;Brown&quot;</span>) {</span>
<span id="cb12-25"><a href="#cb12-25" tabindex="-1"></a>            <span class="cf">if</span> (Freq <span class="sc">&gt;=</span> <span class="dv">25</span>) {</span>
<span id="cb12-26"><a href="#cb12-26" tabindex="-1"></a>              </span>
<span id="cb12-27"><a href="#cb12-27" tabindex="-1"></a>              <span class="fu">output</span>()</span>
<span id="cb12-28"><a href="#cb12-28" tabindex="-1"></a>              </span>
<span id="cb12-29"><a href="#cb12-29" tabindex="-1"></a>            }</span>
<span id="cb12-30"><a href="#cb12-30" tabindex="-1"></a>          }</span>
<span id="cb12-31"><a href="#cb12-31" tabindex="-1"></a>  </span>
<span id="cb12-32"><a href="#cb12-32" tabindex="-1"></a>        })</span>
<span id="cb12-33"><a href="#cb12-33" tabindex="-1"></a></span>
<span id="cb12-34"><a href="#cb12-34" tabindex="-1"></a>res2</span>
<span id="cb12-35"><a href="#cb12-35" tabindex="-1"></a><span class="co">#    Hair   Eye    Sex Freq</span></span>
<span id="cb12-36"><a href="#cb12-36" tabindex="-1"></a><span class="co"># 1 Black Brown   Male   32</span></span>
<span id="cb12-37"><a href="#cb12-37" tabindex="-1"></a><span class="co"># 2 Brown Brown   Male   53</span></span>
<span id="cb12-38"><a href="#cb12-38" tabindex="-1"></a><span class="co"># 3 Black Brown Female   36</span></span>
<span id="cb12-39"><a href="#cb12-39" tabindex="-1"></a><span class="co"># 4 Brown Brown Female   66</span></span></code></pre></div>
<p>You can also use the <code>output()</code> function to create
datasets from scratch, just like in SAS®. To create a dataset from
scratch, simply pass in an empty data frame and output the desired
values.</p>
<div class="sourceCode" id="cb13"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb13-1"><a href="#cb13-1" tabindex="-1"></a><span class="co"># Create metadata </span></span>
<span id="cb13-2"><a href="#cb13-2" tabindex="-1"></a>res3 <span class="ot">&lt;-</span> <span class="fu">datastep</span>(<span class="fu">data.frame</span>(), {</span>
<span id="cb13-3"><a href="#cb13-3" tabindex="-1"></a>  </span>
<span id="cb13-4"><a href="#cb13-4" tabindex="-1"></a>  </span>
<span id="cb13-5"><a href="#cb13-5" tabindex="-1"></a>          name <span class="ot">&lt;-</span> <span class="st">&quot;mtcars&quot;</span></span>
<span id="cb13-6"><a href="#cb13-6" tabindex="-1"></a>          rows <span class="ot">&lt;-</span> <span class="fu">nrow</span>(mtcars)</span>
<span id="cb13-7"><a href="#cb13-7" tabindex="-1"></a>          cols <span class="ot">&lt;-</span> <span class="fu">ncol</span>(mtcars)</span>
<span id="cb13-8"><a href="#cb13-8" tabindex="-1"></a>          <span class="fu">output</span>()</span>
<span id="cb13-9"><a href="#cb13-9" tabindex="-1"></a>          </span>
<span id="cb13-10"><a href="#cb13-10" tabindex="-1"></a>          name <span class="ot">&lt;-</span> <span class="st">&quot;iris&quot;</span></span>
<span id="cb13-11"><a href="#cb13-11" tabindex="-1"></a>          rows <span class="ot">&lt;-</span> <span class="fu">nrow</span>(iris)</span>
<span id="cb13-12"><a href="#cb13-12" tabindex="-1"></a>          cols <span class="ot">&lt;-</span> <span class="fu">ncol</span>(iris)</span>
<span id="cb13-13"><a href="#cb13-13" tabindex="-1"></a>          <span class="fu">output</span>()</span>
<span id="cb13-14"><a href="#cb13-14" tabindex="-1"></a></span>
<span id="cb13-15"><a href="#cb13-15" tabindex="-1"></a>          name <span class="ot">&lt;-</span> <span class="st">&quot;beaver1&quot;</span></span>
<span id="cb13-16"><a href="#cb13-16" tabindex="-1"></a>          rows <span class="ot">&lt;-</span> <span class="fu">nrow</span>(beaver1)</span>
<span id="cb13-17"><a href="#cb13-17" tabindex="-1"></a>          cols <span class="ot">&lt;-</span> <span class="fu">ncol</span>(beaver1)</span>
<span id="cb13-18"><a href="#cb13-18" tabindex="-1"></a>          <span class="fu">output</span>()</span>
<span id="cb13-19"><a href="#cb13-19" tabindex="-1"></a>          </span>
<span id="cb13-20"><a href="#cb13-20" tabindex="-1"></a>  </span>
<span id="cb13-21"><a href="#cb13-21" tabindex="-1"></a>        })</span>
<span id="cb13-22"><a href="#cb13-22" tabindex="-1"></a></span>
<span id="cb13-23"><a href="#cb13-23" tabindex="-1"></a>res3</span>
<span id="cb13-24"><a href="#cb13-24" tabindex="-1"></a><span class="co">#      name rows cols</span></span>
<span id="cb13-25"><a href="#cb13-25" tabindex="-1"></a><span class="co"># 1  mtcars   32   11</span></span>
<span id="cb13-26"><a href="#cb13-26" tabindex="-1"></a><span class="co"># 2    iris  150    5</span></span>
<span id="cb13-27"><a href="#cb13-27" tabindex="-1"></a><span class="co"># 3 beaver1  114    4</span></span></code></pre></div>
</div>
<div id="set-and-merge-operations" class="section level3">
<h3>Set and Merge Operations</h3>
<p>When working with data, joining datasets is an essential activity.
While there are many different functions in R to perform joins, the
<code>datastep()</code> “set” and “merge” parameters offer unusual
flexibility.</p>
<p>The “set” parameter stacks two or more datasets. The “merge”
parameter joins two or more datasets. Together, these two parameters
allow you to perform the most common types of data combinations.</p>
<p>To illustrate, first let’s create up some sample datasets. The
datasets we will create include one “region” dataset, and two “stores”
datasets. Note that the columns on the stores datasets are not
identical.</p>
<div class="sourceCode" id="cb14"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb14-1"><a href="#cb14-1" tabindex="-1"></a><span class="co"># Create sample data</span></span>
<span id="cb14-2"><a href="#cb14-2" tabindex="-1"></a>region <span class="ot">&lt;-</span> <span class="fu">read.table</span>(<span class="at">header =</span> <span class="cn">TRUE</span>, <span class="at">text =</span> <span class="st">&#39;</span></span>
<span id="cb14-3"><a href="#cb14-3" tabindex="-1"></a><span class="st">  REGION   NAME</span></span>
<span id="cb14-4"><a href="#cb14-4" tabindex="-1"></a><span class="st">  R01      East</span></span>
<span id="cb14-5"><a href="#cb14-5" tabindex="-1"></a><span class="st">  R02      West</span></span>
<span id="cb14-6"><a href="#cb14-6" tabindex="-1"></a><span class="st">  R03      North</span></span>
<span id="cb14-7"><a href="#cb14-7" tabindex="-1"></a><span class="st">  R04      South</span></span>
<span id="cb14-8"><a href="#cb14-8" tabindex="-1"></a><span class="st">&#39;</span>, <span class="at">stringsAsFactors =</span> <span class="cn">FALSE</span>)</span>
<span id="cb14-9"><a href="#cb14-9" tabindex="-1"></a></span>
<span id="cb14-10"><a href="#cb14-10" tabindex="-1"></a><span class="co"># First stores dataset</span></span>
<span id="cb14-11"><a href="#cb14-11" tabindex="-1"></a>stores1 <span class="ot">&lt;-</span> <span class="fu">read.table</span>(<span class="at">header =</span> <span class="cn">TRUE</span>, <span class="at">text =</span> <span class="st">&#39;</span></span>
<span id="cb14-12"><a href="#cb14-12" tabindex="-1"></a><span class="st">  ID  NAME             SIZE REGION FRANCHISE</span></span>
<span id="cb14-13"><a href="#cb14-13" tabindex="-1"></a><span class="st">  A01 &quot;Eastern Lumber&quot;    L    R01        T</span></span>
<span id="cb14-14"><a href="#cb14-14" tabindex="-1"></a><span class="st">  A02 &quot;Tri-City Hardwood&quot; M    R02        F</span></span>
<span id="cb14-15"><a href="#cb14-15" tabindex="-1"></a><span class="st">  A05 &quot;Reliable Hardware&quot; S    R01        T</span></span>
<span id="cb14-16"><a href="#cb14-16" tabindex="-1"></a><span class="st">&#39;</span>, <span class="at">stringsAsFactors =</span> <span class="cn">FALSE</span>)</span>
<span id="cb14-17"><a href="#cb14-17" tabindex="-1"></a></span>
<span id="cb14-18"><a href="#cb14-18" tabindex="-1"></a><span class="co"># Extra column on this one</span></span>
<span id="cb14-19"><a href="#cb14-19" tabindex="-1"></a>stores2 <span class="ot">&lt;-</span> <span class="fu">read.table</span>(<span class="at">header =</span> <span class="cn">TRUE</span>, <span class="at">text =</span> <span class="st">&#39;</span></span>
<span id="cb14-20"><a href="#cb14-20" tabindex="-1"></a><span class="st">  ID  NAME             SIZE REGION</span></span>
<span id="cb14-21"><a href="#cb14-21" tabindex="-1"></a><span class="st">  A03 &quot;AAA Mills&quot;         S    R05</span></span>
<span id="cb14-22"><a href="#cb14-22" tabindex="-1"></a><span class="st">  A04 &quot;Home and Yard&quot;     L    R03</span></span>
<span id="cb14-23"><a href="#cb14-23" tabindex="-1"></a><span class="st">&#39;</span>, <span class="at">stringsAsFactors =</span> <span class="cn">FALSE</span>)</span></code></pre></div>
<p>Despite not having the same columns, the two stores datasets can be
set using the <code>datastep()</code> function. The function will fill
in the missing values automatically. Like so:</p>
<div class="sourceCode" id="cb15"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb15-1"><a href="#cb15-1" tabindex="-1"></a><span class="co"># Set operation</span></span>
<span id="cb15-2"><a href="#cb15-2" tabindex="-1"></a>allstores <span class="ot">&lt;-</span> <span class="fu">datastep</span>(stores1, <span class="at">set =</span> stores2, {})</span>
<span id="cb15-3"><a href="#cb15-3" tabindex="-1"></a></span>
<span id="cb15-4"><a href="#cb15-4" tabindex="-1"></a><span class="co"># Extra values filled with NA</span></span>
<span id="cb15-5"><a href="#cb15-5" tabindex="-1"></a>allstores</span>
<span id="cb15-6"><a href="#cb15-6" tabindex="-1"></a><span class="co">#    ID              NAME SIZE REGION FRANCHISE</span></span>
<span id="cb15-7"><a href="#cb15-7" tabindex="-1"></a><span class="co"># 1 A01    Eastern Lumber    L    R01      TRUE</span></span>
<span id="cb15-8"><a href="#cb15-8" tabindex="-1"></a><span class="co"># 2 A02 Tri-City Hardwood    M    R02     FALSE</span></span>
<span id="cb15-9"><a href="#cb15-9" tabindex="-1"></a><span class="co"># 3 A05 Reliable Hardware    S    R01      TRUE</span></span>
<span id="cb15-10"><a href="#cb15-10" tabindex="-1"></a><span class="co"># 4 A03         AAA Mills    S    R05        NA</span></span>
<span id="cb15-11"><a href="#cb15-11" tabindex="-1"></a><span class="co"># 5 A04     Home and Yard    L    R03        NA</span></span></code></pre></div>
<p>Let’s pretend we noticed the missing data, and decide to fill it in.
We can do that by merging the missing FRANCHISE values to the second
stores dataset. First let’s create the missing data:</p>
<div class="sourceCode" id="cb16"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb16-1"><a href="#cb16-1" tabindex="-1"></a><span class="co"># Create small dataset of missing FRANCHISE values</span></span>
<span id="cb16-2"><a href="#cb16-2" tabindex="-1"></a>franchises <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(<span class="at">FRANCHISE =</span> <span class="fu">c</span>(F, F), <span class="at">stringsAsFactors =</span> <span class="cn">FALSE</span>) </span>
<span id="cb16-3"><a href="#cb16-3" tabindex="-1"></a>franchises</span>
<span id="cb16-4"><a href="#cb16-4" tabindex="-1"></a><span class="co">#   FRANCHISE</span></span>
<span id="cb16-5"><a href="#cb16-5" tabindex="-1"></a><span class="co"># 1     FALSE</span></span>
<span id="cb16-6"><a href="#cb16-6" tabindex="-1"></a><span class="co"># 2     FALSE</span></span></code></pre></div>
<p>Next we can merge in the missing data on “stores2”, and set the two
store datasets again:</p>
<div class="sourceCode" id="cb17"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb17-1"><a href="#cb17-1" tabindex="-1"></a><span class="co"># Merge in missing FRANCHISE column</span></span>
<span id="cb17-2"><a href="#cb17-2" tabindex="-1"></a>stores2mod <span class="ot">&lt;-</span> <span class="fu">datastep</span>(stores2, <span class="at">merge =</span> franchises, {})</span>
<span id="cb17-3"><a href="#cb17-3" tabindex="-1"></a>stores2mod</span>
<span id="cb17-4"><a href="#cb17-4" tabindex="-1"></a><span class="co">#    ID          NAME SIZE REGION FRANCHISE</span></span>
<span id="cb17-5"><a href="#cb17-5" tabindex="-1"></a><span class="co"># 1 A03     AAA Mills    S    R05     FALSE</span></span>
<span id="cb17-6"><a href="#cb17-6" tabindex="-1"></a><span class="co"># 2 A04 Home and Yard    L    R03     FALSE</span></span>
<span id="cb17-7"><a href="#cb17-7" tabindex="-1"></a></span>
<span id="cb17-8"><a href="#cb17-8" tabindex="-1"></a><span class="co"># Set again</span></span>
<span id="cb17-9"><a href="#cb17-9" tabindex="-1"></a>allstores <span class="ot">&lt;-</span> <span class="fu">datastep</span>(stores1, <span class="at">set =</span> stores2mod, {})</span>
<span id="cb17-10"><a href="#cb17-10" tabindex="-1"></a></span>
<span id="cb17-11"><a href="#cb17-11" tabindex="-1"></a><span class="co"># Now everything is aligned</span></span>
<span id="cb17-12"><a href="#cb17-12" tabindex="-1"></a>allstores</span>
<span id="cb17-13"><a href="#cb17-13" tabindex="-1"></a><span class="co">#    ID              NAME SIZE REGION FRANCHISE</span></span>
<span id="cb17-14"><a href="#cb17-14" tabindex="-1"></a><span class="co"># 1 A01    Eastern Lumber    L    R01      TRUE</span></span>
<span id="cb17-15"><a href="#cb17-15" tabindex="-1"></a><span class="co"># 2 A02 Tri-City Hardwood    M    R02     FALSE</span></span>
<span id="cb17-16"><a href="#cb17-16" tabindex="-1"></a><span class="co"># 3 A05 Reliable Hardware    S    R01      TRUE</span></span>
<span id="cb17-17"><a href="#cb17-17" tabindex="-1"></a><span class="co"># 4 A03         AAA Mills    S    R05     FALSE</span></span>
<span id="cb17-18"><a href="#cb17-18" tabindex="-1"></a><span class="co"># 5 A04     Home and Yard    L    R03     FALSE</span></span></code></pre></div>
<p>Observe that we did not have to specify a join condition on the
merge. When no “merge_by” is indicated, the datastep will simply append
the new columns to the right - without complaining. This behavior is
very convenient.</p>
<p>Now let’s do another join, but this time we will specify a join
condition. We will join in the store regions by the region ID. We will
also set up merge flags so we can see which rows were in which input
dataset.</p>
<div class="sourceCode" id="cb18"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb18-1"><a href="#cb18-1" tabindex="-1"></a></span>
<span id="cb18-2"><a href="#cb18-2" tabindex="-1"></a><span class="co"># Merge operation - Outer Join</span></span>
<span id="cb18-3"><a href="#cb18-3" tabindex="-1"></a>res <span class="ot">&lt;-</span> <span class="fu">datastep</span>(allstores, <span class="at">merge =</span> region,</span>
<span id="cb18-4"><a href="#cb18-4" tabindex="-1"></a>                <span class="at">merge_by =</span> <span class="st">&quot;REGION&quot;</span>,</span>
<span id="cb18-5"><a href="#cb18-5" tabindex="-1"></a>                <span class="at">merge_in =</span> <span class="fu">c</span>(<span class="st">&quot;inA&quot;</span>, <span class="st">&quot;inB&quot;</span>), {})</span>
<span id="cb18-6"><a href="#cb18-6" tabindex="-1"></a></span>
<span id="cb18-7"><a href="#cb18-7" tabindex="-1"></a><span class="co"># View results</span></span>
<span id="cb18-8"><a href="#cb18-8" tabindex="-1"></a>res</span>
<span id="cb18-9"><a href="#cb18-9" tabindex="-1"></a><span class="co">#     ID            NAME.1 SIZE REGION FRANCHISE NAME.2 inA inB</span></span>
<span id="cb18-10"><a href="#cb18-10" tabindex="-1"></a><span class="co"># 1  A01    Eastern Lumber    L    R01      TRUE   East   1   1</span></span>
<span id="cb18-11"><a href="#cb18-11" tabindex="-1"></a><span class="co"># 2  A05 Reliable Hardware    S    R01      TRUE   East   1   1</span></span>
<span id="cb18-12"><a href="#cb18-12" tabindex="-1"></a><span class="co"># 3  A02 Tri-City Hardwood    M    R02     FALSE   West   1   1</span></span>
<span id="cb18-13"><a href="#cb18-13" tabindex="-1"></a><span class="co"># 4  A04     Home and Yard    L    R03     FALSE  North   1   1</span></span>
<span id="cb18-14"><a href="#cb18-14" tabindex="-1"></a><span class="co"># 5  A03         AAA Mills    S    R05     FALSE   &lt;NA&gt;   1   0</span></span>
<span id="cb18-15"><a href="#cb18-15" tabindex="-1"></a><span class="co"># 6 &lt;NA&gt;              &lt;NA&gt; &lt;NA&gt;    R04        NA  South   0   1</span></span></code></pre></div>
<p>Notice three things:</p>
<ol style="list-style-type: decimal">
<li>The “Name” field appeared in both datasets, and was therefore
appended with suffixes to distinguish them.</li>
<li>The region value “R05” is in the stores dataset, but not in the
region dataset. It appears this value was coded incorrectly.</li>
<li>Region “R04” had no stores.</li>
</ol>
<p>Let’s try one last time to fix the above issues. We can fix the
column names with the “rename” parameter, and exclude rows with a
“where” expression. Also, we can recode “R05” to “R04” inside the
datastep. Finally, we’ll drop the merge flags to clean up the
columns.</p>
<div class="sourceCode" id="cb19"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb19-1"><a href="#cb19-1" tabindex="-1"></a></span>
<span id="cb19-2"><a href="#cb19-2" tabindex="-1"></a><span class="co"># Merge operation - Left join and clean up</span></span>
<span id="cb19-3"><a href="#cb19-3" tabindex="-1"></a>res <span class="ot">&lt;-</span> <span class="fu">datastep</span>(allstores, <span class="at">merge =</span> region,</span>
<span id="cb19-4"><a href="#cb19-4" tabindex="-1"></a>                <span class="at">merge_by =</span> <span class="st">&quot;REGION&quot;</span>,</span>
<span id="cb19-5"><a href="#cb19-5" tabindex="-1"></a>                <span class="at">merge_in =</span> <span class="fu">c</span>(<span class="st">&quot;inA&quot;</span>, <span class="st">&quot;inB&quot;</span>), </span>
<span id="cb19-6"><a href="#cb19-6" tabindex="-1"></a>                <span class="at">rename =</span> <span class="fu">c</span>(<span class="at">NAME.1 =</span> <span class="st">&quot;STORE_NAME&quot;</span>, <span class="at">NAME.2 =</span> <span class="st">&quot;REGION_NAME&quot;</span>),</span>
<span id="cb19-7"><a href="#cb19-7" tabindex="-1"></a>                <span class="at">where =</span> <span class="fu">expression</span>(inA <span class="sc">==</span> <span class="cn">TRUE</span>),</span>
<span id="cb19-8"><a href="#cb19-8" tabindex="-1"></a>                <span class="at">drop =</span> <span class="fu">c</span>(<span class="st">&quot;inA&quot;</span>, <span class="st">&quot;inB&quot;</span>),</span>
<span id="cb19-9"><a href="#cb19-9" tabindex="-1"></a>                {</span>
<span id="cb19-10"><a href="#cb19-10" tabindex="-1"></a>                  <span class="cf">if</span> (REGION <span class="sc">==</span> <span class="st">&quot;R05&quot;</span>) {</span>
<span id="cb19-11"><a href="#cb19-11" tabindex="-1"></a>                    REGION <span class="ot">&lt;-</span> <span class="st">&quot;R04&quot;</span></span>
<span id="cb19-12"><a href="#cb19-12" tabindex="-1"></a>                    NAME<span class="fl">.2</span> <span class="ot">&lt;-</span> <span class="st">&quot;South&quot;</span></span>
<span id="cb19-13"><a href="#cb19-13" tabindex="-1"></a>                    </span>
<span id="cb19-14"><a href="#cb19-14" tabindex="-1"></a>                  }</span>
<span id="cb19-15"><a href="#cb19-15" tabindex="-1"></a>                  </span>
<span id="cb19-16"><a href="#cb19-16" tabindex="-1"></a>                })</span>
<span id="cb19-17"><a href="#cb19-17" tabindex="-1"></a><span class="co">#&#39;</span></span>
<span id="cb19-18"><a href="#cb19-18" tabindex="-1"></a><span class="co"># View results </span></span>
<span id="cb19-19"><a href="#cb19-19" tabindex="-1"></a>res</span>
<span id="cb19-20"><a href="#cb19-20" tabindex="-1"></a><span class="co">#    ID        STORE_NAME SIZE REGION FRANCHISE REGION_NAME</span></span>
<span id="cb19-21"><a href="#cb19-21" tabindex="-1"></a><span class="co"># 1 A01    Eastern Lumber    L    R01      TRUE        East</span></span>
<span id="cb19-22"><a href="#cb19-22" tabindex="-1"></a><span class="co"># 2 A05 Reliable Hardware    S    R01      TRUE        East</span></span>
<span id="cb19-23"><a href="#cb19-23" tabindex="-1"></a><span class="co"># 3 A02 Tri-City Hardwood    M    R02     FALSE        West</span></span>
<span id="cb19-24"><a href="#cb19-24" tabindex="-1"></a><span class="co"># 4 A04     Home and Yard    L    R03     FALSE       North</span></span>
<span id="cb19-25"><a href="#cb19-25" tabindex="-1"></a><span class="co"># 5 A03         AAA Mills    S    R04     FALSE       South</span></span></code></pre></div>
</div>
<div id="datastep-performance" class="section level3">
<h3>Datastep Performance</h3>
<p>One weakness of the <strong>libr</strong> <code>datastep()</code>
function is performance. The function is far slower than the equivalent
SAS® datastep. The performance profile may limit the number of records
you are able to reasonably process with the <code>datastep()</code>.</p>
<p>One thing you can do to increase performance is to reduce the number
of rows and columns on the input data. You can perform this
pre-filtering with Base R or <strong>Tidyverse</strong> functions. This
strategy is particularly recommended if you were planning to subset the
data anyway using the “where” or “keep” options.</p>
<p>The Base R <code>subset()</code> function is convenient to use
because it is always available. Here is an example showing how to reduce
the size of the <strong>iris</strong> sample dataframe using Base R
<code>subset()</code> before sending it to a datastep.</p>
<div id="example-10-increasing-performance" class="section level4">
<h4>Example 10: Increasing Performance</h4>
<pre><code># Subset the input dataset first for only needed rows and columns
dat &lt;- subset(iris, Species == &#39;versicolor&#39;, c(&#39;Petal.Length&#39;, &#39;Petal.Width&#39;)) |&gt; 
       datastep({
       
         if (Petal.Length &lt; 3.5)
            Petal.Size &lt;- &quot;Short&quot;
         else if (Petal.Length &gt; 4.5)
            Petal.Size &lt;- &quot;Long&quot;
         else
            Petal.Size &lt;- &quot;Medium&quot;
       
       })

# View Some Results
dat[1:10, ]
#    Petal.Length Petal.Width Petal.Size
# 1           4.7         1.4       Long
# 2           4.5         1.5     Medium
# 3           4.9         1.5       Long
# 4           4.0         1.3     Medium
# 5           4.6         1.5       Long
# 6           4.5         1.3     Medium
# 7           4.7         1.6       Long
# 8           3.3         1.0      Short
# 9           4.6         1.3       Long
# 10          3.9         1.4     Medium
</code></pre>
<p>Next: <a href="libr-disclaimer.html">Disclaimer</a></p>
</div>
</div>



<!-- code folding -->


<!-- dynamically load mathjax for compatibility with self-contained -->
<script>
  (function () {
    var script = document.createElement("script");
    script.type = "text/javascript";
    script.src  = "https://mathjax.rstudio.com/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML";
    document.getElementsByTagName("head")[0].appendChild(script);
  })();
</script>

</body>
</html>
